<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QG GARDIENS - Interface Tactique v7.0 (Manual Override)</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --neon-blue: #00f3ff;
            --neon-red: #ff003c;
            --neon-gold: #ffd700;
            --bg-dark: #050a10;
            --panel-bg: rgba(5, 10, 16, 0.95);
            --grid-color: rgba(0, 243, 255, 0.05);
        }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg-dark);
            font-family: 'Share Tech Mono', monospace;
            color: white; overflow: hidden;
        }

        #map {
            height: 100vh; width: 100%; z-index: 1;
            filter: sepia(20%) contrast(110%) saturate(60%) hue-rotate(180deg) invert(10%); 
        }

        /* --- FX COUCHES VISUELLES --- */
        .grid-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: linear-gradient(var(--grid-color) 1px, transparent 1px), linear-gradient(90deg, var(--grid-color) 1px, transparent 1px);
            background-size: 40px 40px; z-index: 9000; pointer-events: none;
        }
        
        .scanlines {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.2) 50%, rgba(0,0,0,0.2));
            background-size: 100% 3px; z-index: 9001; pointer-events: none; opacity: 0.3;
        }
        
        .vignette {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            box-shadow: 0 0 200px rgba(0,0,0,1) inset; z-index: 9002; pointer-events: none;
        }

        .radar-sweep {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 150vmax; height: 150vmax; border-radius: 50%;
            background: conic-gradient(from 0deg, transparent 0deg, transparent 300deg, rgba(0, 243, 255, 0.05) 340deg, rgba(0, 243, 255, 0.2) 360deg);
            z-index: 8000; pointer-events: none; animation: radarSpin 8s linear infinite; mix-blend-mode: screen;
        }
        @keyframes radarSpin { from { transform: translate(-50%, -50%) rotate(0deg); } to { transform: translate(-50%, -50%) rotate(360deg); } }

        /* --- HUD --- */
        .hud-header {
            position: absolute; top: 0; left: 0; width: 100%; padding: 15px 25px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.95), transparent);
            z-index: 10000; pointer-events: none; display: flex; justify-content: space-between;
            border-top: 3px solid var(--neon-blue); box-sizing: border-box;
        }
        
        .title-box { pointer-events: auto; text-shadow: 0 0 10px var(--neon-blue); }
        .title-box h1 { margin: 0; font-family: 'Rajdhani', sans-serif; font-weight: 800; font-size: 32px; letter-spacing: 4px; color: var(--neon-blue); }
        
        .status-box { text-align: right; }
        .status-badge {
            background: rgba(0, 243, 255, 0.1); border: 1px solid var(--neon-blue); color: var(--neon-blue); 
            padding: 4px 8px; font-size: 10px; display: inline-block; margin-bottom: 5px;
            box-shadow: 0 0 10px rgba(0, 243, 255, 0.2);
        }

        /* --- MARKERS --- */
        .marker-icon {
            background: black; border: 1px solid white; display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 10px; width: 100%; height: 100%; transition: all 0.3s;
            position: relative; z-index: 100;
        }
        .shape-circle { border-radius: 50%; }
        .shape-square { transform: rotate(45deg); }
        .shape-hex { clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%); background: var(--neon-gold); color: black; border: none; }

        .marker-danger .marker-icon { border-color: var(--neon-red); color: var(--neon-red); box-shadow: 0 0 8px var(--neon-red); }
        .marker-safe .marker-icon { border-color: var(--neon-blue); color: var(--neon-blue); box-shadow: 0 0 8px var(--neon-blue); }
        .marker-intel .marker-icon { border-color: var(--neon-gold); color: var(--neon-gold); box-shadow: 0 0 8px var(--neon-gold); }

        .marker-icon:hover { transform: scale(1.3); z-index: 9999; cursor: crosshair; background: white; color: black !important; }

        /* Animation Target Lock */
        .target-lock {
            position: absolute; width: 80px; height: 80px; top: 50%; left: 50%; transform: translate(-50%, -50%);
            pointer-events: none; z-index: 90; display: none;
        }
        .target-lock::before {
            content: ''; position: absolute; inset: 0; border: 1px dashed var(--neon-blue); border-radius: 50%;
            animation: spin 6s linear infinite; opacity: 0.7;
        }
        .target-lock::after {
            content: ''; position: absolute; inset: 10px; border: 2px solid var(--neon-blue); 
            border-left: transparent; border-right: transparent; border-radius: 50%;
            animation: spin 3s linear infinite reverse;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* --- SIDEBAR --- */
        #info-panel {
            position: absolute; top: 0; right: -550px; width: 500px; height: 100vh;
            background: var(--panel-bg); border-left: 2px solid var(--neon-blue);
            z-index: 10001; padding: 40px 30px; transition: right 0.5s cubic-bezier(0.77, 0, 0.175, 1);
            box-shadow: -20px 0 100px rgba(0,0,0,0.9); display: flex; flex-direction: column;
            backdrop-filter: blur(15px);
        }
        #info-panel.active { right: 0; }
        
        .folder-tab {
            position: absolute; top: 120px; left: -40px; width: 40px; height: 120px;
            background: var(--neon-blue); color: black; font-family: 'Rajdhani'; font-weight: 800; font-size: 18px;
            writing-mode: vertical-rl; text-align: center; display: flex; align-items: center; justify-content: center;
            cursor: pointer; clip-path: polygon(0 10%, 100% 0, 100% 100%, 0 90%);
            transition: all 0.2s;
        }
        .folder-tab:hover { background: white; }

        .data-header { border-bottom: 2px solid #333; margin-bottom: 20px; padding-bottom: 15px; position: relative; }
        .data-title { font-family: 'Rajdhani', sans-serif; font-size: 36px; font-weight: 800; margin: 0; text-transform: uppercase; line-height: 0.9; }
        .data-meta { display: flex; justify-content: space-between; margin-top: 8px; font-size: 11px; color: #666; font-family: 'Courier New'; }

        .classified-stamp {
            position: absolute; top: 0; right: 0; border: 3px solid var(--neon-red); color: var(--neon-red);
            font-size: 16px; font-weight: 900; padding: 5px 15px; transform: rotate(-15deg);
            opacity: 0.8; letter-spacing: 3px; mix-blend-mode: screen; pointer-events: none;
        }

        .data-content { flex-grow: 1; overflow-y: auto; padding-right: 10px; }
        
        .typewriter-text {
            font-size: 14px; line-height: 1.6; color: #ddd; margin-bottom: 20px;
            border-left: 2px solid #333; padding-left: 15px;
        }
        .cursor::after { content: '█'; animation: blink 1s infinite; color: var(--neon-blue); }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

        .evidence-box { background: rgba(0,0,0,0.5); border: 1px solid #333; padding: 2px; margin-top: 20px; }
        .evidence-header { background: #111; color: #666; padding: 5px 10px; font-size: 10px; text-transform: uppercase; letter-spacing: 1px; }
        
        .evidence-img {
            width: 100%; height: 250px; background: #000;
            display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative;
        }
        .evidence-img img {
            width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity 1s;
            filter: contrast(1.2) saturate(0.8) sepia(0.2);
        }
        .evidence-img img.loaded { opacity: 1; }
        .evidence-overlay {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: linear-gradient(to bottom, transparent 80%, black 100%);
            pointer-events: none;
        }

        /* --- CONTROLS --- */
        .controls-container {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            width: 80%; max-width: 800px; z-index: 10000;
            display: flex; flex-direction: column; gap: 15px; pointer-events: none;
        }
        
        .timeline-wrapper {
            background: rgba(0,0,0,0.9); border: 1px solid #333; border-radius: 40px;
            padding: 15px 30px; pointer-events: auto; display: flex; flex-direction: column; gap: 5px;
            box-shadow: 0 0 30px rgba(0,0,0,0.5); position: relative;
        }
        .timeline-wrapper::before {
            content:''; position: absolute; top:-2px; left:20%; right:20%; height:2px; background: var(--neon-blue);
        }

        .year-display {
            text-align: center; font-size: 14px; color: var(--neon-blue); font-weight: bold; letter-spacing: 2px;
        }
        
        input[type=range] { width: 100%; cursor: pointer; height: 4px; background: #333; -webkit-appearance: none; margin: 15px 0; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 20px; width: 20px; background: black; border: 2px solid var(--neon-blue);
            cursor: pointer; transform: rotate(45deg); box-shadow: 0 0 15px var(--neon-blue);
        }

        .filter-bar {
            display: flex; justify-content: center; gap: 10px; pointer-events: auto;
        }
        .btn-tac {
            background: rgba(0,0,0,0.8); border: 1px solid #444; color: #888;
            padding: 8px 20px; font-family: 'Share Tech Mono'; cursor: pointer;
            text-transform: uppercase; font-size: 11px; transition: all 0.2s;
            clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
        }
        .btn-tac:hover, .btn-tac.active {
            background: var(--neon-blue); color: black; border-color: var(--neon-blue); box-shadow: 0 0 20px rgba(0, 243, 255, 0.3);
        }
        .btn-tac.danger:hover, .btn-tac.danger.active {
            background: var(--neon-red); color: white; border-color: var(--neon-red); box-shadow: 0 0 20px rgba(255, 0, 60, 0.3);
        }

        .story-btn {
            position: absolute; top: 100px; right: 30px; z-index: 10000; pointer-events: auto;
            background: var(--neon-red); color: white; border: none;
            padding: 15px 40px; font-family: 'Rajdhani'; font-weight: 800; font-size: 20px;
            cursor: pointer; clip-path: polygon(20px 0, 100% 0, 100% 100%, 0 100%, 0 20px);
            animation: pulse-red 2s infinite; text-transform: uppercase; letter-spacing: 2px;
        }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(255, 0, 60, 0.4); } 70% { box-shadow: 0 0 0 20px rgba(255, 0, 60, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 0, 60, 0); } }

        /* Bouton Suivant dans le Panel */
        .btn-next-step {
            margin-top: 20px; width: 100%; background: var(--neon-blue); color: black;
            border: none; padding: 15px; font-family: 'Rajdhani'; font-weight: bold; font-size: 18px;
            cursor: pointer; clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
            transition: all 0.2s;
        }
        .btn-next-step:hover { background: white; }

        /* Checkbox Auto-Play */
        .autoplay-control {
            position: absolute; top: 160px; right: 30px; z-index: 10000; pointer-events: auto;
            background: rgba(0,0,0,0.8); border: 1px solid #444; padding: 10px;
            font-size: 11px; color: var(--neon-blue); display: flex; align-items: center; gap: 10px;
        }
        input[type="checkbox"] { width: auto; margin: 0; }

    </style>
</head>
<body>

    <div class="grid-overlay"></div>
    <div class="scanlines"></div>
    <div class="vignette"></div>
    <div class="radar-sweep"></div>

    <div class="hud-header">
        <div class="title-box">
            <h1>CHRONOS <span style="color:white; font-size:14px;">// TACTICAL MAP</span></h1>
            <div style="font-size: 10px; color: #aaa; letter-spacing: 2px;">SECURE CONNECTION ESTABLISHED TO PRAGUE SERVER</div>
        </div>
        <div class="status-box">
            <div class="status-badge">LIVE FEED</div>
            <div id="date-display" style="font-size: 32px; font-weight:bold; color:white; font-family:'Rajdhani';">2025</div>
        </div>
    </div>

    <div id="map"></div>

    <button class="story-btn" id="btn-story" onclick="startStoryMode()">Lancer la Traque</button>
    <div class="autoplay-control">
        <input type="checkbox" id="autoPlayCheck">
        <label for="autoPlayCheck">AUTO-SIMULATION</label>
    </div>

    <div class="controls-container">
        <div class="timeline-wrapper">
            <div class="year-display">ANNÉE CIBLE : <span id="timeline-val" style="color:white;">2025</span></div>
            <input type="range" min="2025" max="2034" value="2025" step="1" id="timeline-slider" oninput="updateTimeline(this.value)">
            <div style="display:flex; justify-content:space-between; width:100%; font-size:9px; color:#555;">
                <span>2025</span><span>2026</span><span>2027</span><span>2028</span><span>2029</span><span>2030</span><span>2031</span><span>2032</span><span>2033</span><span>2034</span>
            </div>
        </div>
        
        <div class="filter-bar">
            <button class="btn-tac active" onclick="setFilter('all')">TOUS</button>
            <button class="btn-tac danger" onclick="setFilter('danger')">MENACES (VEILLEURS)</button>
            <button class="btn-tac" onclick="setFilter('safe')">REFUGES (GARDIENS)</button>
            <button class="btn-tac" onclick="setFilter('intel')">ARCHIVES</button>
        </div>
    </div>

    <div id="info-panel">
        <div class="folder-tab" onclick="closePanel()">FERMER X</div>
        <div id="panel-content"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const map = L.map('map', { zoomControl: false, attributionControl: false, center: [40, 10], zoom: 3 });
        
        // Calque Sombre Tactique
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            subdomains: 'abcd', maxZoom: 19
        }).addTo(map);

        // --- DONNÉES EXHAUSTIVES (45 LIEUX) ---
        const locations = [
            // 2025
            { id: 1, type: 'intel', lat: 32.54, lng: 44.42, year: 2025, title: 'BABYLONE', date: 'PROLOGUE', desc: 'Point zéro. Le Pr. Shepherd découvre la Tablette de Nabonide cachée dans un mur du site archéologique. Il est assassiné par les Veilleurs, mais réussit à envoyer les photos cryptées à sa fille Rébecca.', artifact: 'Tablette Argile', code: 'CLÉ : 6-7-6-7-10' },
            { id: 2, type: 'safe', lat: 40.344, lng: -74.655, year: 2025, title: 'PRINCETON UNI.', date: 'CHAPITRE 1', desc: 'Bureau de Rébecca au département de mathématiques. Réception du message de son père. Cyberattaque du pare-feu. Fuite in extremis via le laboratoire informatique.', artifact: 'Fichier Fragment_B7', code: 'X-A-D-R-I-N-A' },
            { id: 3, type: 'safe', lat: 40.35, lng: -74.66, year: 2025, title: 'REFUGE KELLER', date: 'NUIT', desc: 'Maison sécurisée à la périphérie de Princeton. Keller active le Protocole Prométhée. Attaque par gaz incapacitant. Fuite par le tunnel d\'égouts caché.', artifact: 'Clé USB Cryptée', code: 'PROTOCOLE PROMÉTHÉE' },
            { id: 4, type: 'safe', lat: 40.27, lng: -74.57, year: 2025, title: 'TEMPLE BETH EL', date: 'AUBE', desc: 'East Windsor Township. Rencontre avec Rabbi Lévi. Révélations sur le Sefer HaTemunah et les cycles de 7000 ans. Le Rabbin est assassiné par les Veilleurs.', artifact: 'Lettre d\'Elijah', code: 'CHRONOLOGIE 6000' },
            { id: 5, type: 'intel', lat: 40.349, lng: -74.663, year: 2025, title: 'BIBLIOTHÈQUE THÉO.', date: 'MATIN', desc: 'Rencontre avec le Dr. Cohen. Embuscade de Galloway. Fusillade dans la salle des archives. Fuite par une fenêtre de service.', artifact: 'Manuscrit Ancien', code: 'CODE 4-9-7-3' },
            { id: 6, type: 'safe', lat: 40.352, lng: -74.658, year: 2025, title: 'THE DAILY GRIND', date: 'JOURNÉE', desc: 'Café à Princeton. Rébecca s\'y réfugie pour analyser le Sefer Yetzirah et découvre le lien gématrique avec le Roi Josaphat (1640).', artifact: 'Livre Sefer Yetzirah', code: '1640 = JOSAPHAT' },
            { id: 7, type: 'intel', lat: 40.351, lng: -74.661, year: 2025, title: 'CIMETIÈRE', date: 'NUIT', desc: 'Chapelle abandonnée. Rencontre avec Élias, le gardien de la mémoire. Il remet l\'Amulette de Nabonide à Rébecca. Fuite par le mausolée de marbre noir.', artifact: 'Amulette Bronze', code: 'ASTROLABE' },
            { id: 8, type: 'safe', lat: 40.76, lng: -73.92, year: 2025, title: 'QUEENS LOCK-UP', date: 'NUIT', desc: 'Astoria, NY. Box 418. Récupération du kit "Ghost" laissé par Keller (faux papiers, maquillage anti-IA). Transformation en Susan Reid.', artifact: 'Faux Passeport', code: 'CODE 19-84-18' },
            { id: 9, type: 'safe', lat: 50.37, lng: 7.28, year: 2025, title: 'MENDIG (TUNNEL)', date: 'MAI 2025', desc: 'Allemagne. Saut spectaculaire du train de marchandises pour échapper aux contrôles de police avant d\'atteindre l\'abbaye.', artifact: 'Carte Ferroviaire', code: 'FUITE' },
            { id: 10, type: 'safe', lat: 50.40, lng: 7.25, year: 2025, title: 'MARIA LAACH', date: 'MAI 2025', desc: 'Abbaye Bénédictine. Découverte de la bibliothèque jésuite cachée derrière un mur pivotant. Frère Adrien révèle les manuscrits confirmant la chronologie.', artifact: 'Manuscrit Bénédictin', code: 'CODE DE BENOÎT' },
            { id: 11, type: 'intel', lat: 41.90, lng: 12.45, year: 2025, title: 'VATICAN', date: 'JUIN 2025', desc: 'Bibliothèque secrète. Keller et Rébecca utilisent l\'amulette pour décoder la prophétie sur le sol en mosaïque. Fuite par le Passetto di Papi.', artifact: 'Mosaïque de la Genèse', code: '7 JOURS' },
            { id: 12, type: 'safe', lat: 50.08, lng: 14.40, year: 2025, title: 'QG PRAGUE', date: 'JUIN 2025', desc: 'Église Notre-Dame-sous-la-Chaîne. Crypte aménagée en base opérationnelle des Gardiens. Cerveau de la résistance.', artifact: 'Serveurs Lames', code: 'BASE ALPHA' },
            { id: 13, type: 'danger', lat: 46.23, lng: 6.05, year: 2025, title: 'CERN - GENÈVE', date: '10 JUIN 2025', desc: 'Sabotage cryogénique du LHC. Infiltration par le tunnel SPS pour empêcher la création de micro trous noirs. Fuite par les conduits d\'hélium.', artifact: 'Aimant Supraconducteur', code: 'PROPHÉTIE : FEU SANS FLAMME' },
            { id: 14, type: 'danger', lat: 37.74, lng: -25.67, year: 2025, title: 'AÇORES', date: '3 SEPT 2025', desc: 'Sabotage des digues sous-marines de la faille médio-atlantique. Tentative de tsunami sur le Portugal déjouée par des brise-lames gonflables.', artifact: 'Drone sous-marin', code: 'PROPHÉTIE : EAUX' },
            
            // 2026
            { id: 15, type: 'danger', lat: 40.75, lng: -73.97, year: 2026, title: 'NY BLACKOUT', date: '1 JAN 2026', desc: 'Attaque du réseau électrique US via le signal horaire. Contre-mesure depuis les tunnels de Grand Central (Piratage de l\'horloge maîtresse).', artifact: 'Oscillateur à Quartz', code: 'PROPHÉTIE : NUIT SANS FIN' },
            { id: 16, type: 'safe', lat: 40.72, lng: -74.00, year: 2026, title: 'SOHO LOFT', date: 'JAN 2026', desc: 'QG temporaire à Manhattan. Loft désaffecté utilisé pour gérer la crise du Blackout en temps réel.', artifact: 'Écrans Surveillance', code: 'BASE BÊTA' },
            { id: 17, type: 'danger', lat: -29.26, lng: -70.73, year: 2026, title: 'DÉSERT D\'ATACAMA', date: '21 JUIN 2026', desc: 'Dissonance Cosmique. Antennes ELF de Burke perturbant la magnétosphère. Sarah détruit l\'installation avec un résonateur à quartz.', artifact: 'Cristal de Lithium', code: 'PROPHÉTIE : BOUSSOLE' },

            // 2027
            { id: 18, type: 'danger', lat: 52.13, lng: -106.67, year: 2027, title: 'AGROGEN', date: 'AVRIL 2027', desc: 'Saskatoon, Canada. Découverte de la modification génétique de la Rouille du Blé sur une grue morte.', artifact: 'Plume de Grue', code: 'CIBLE : FAMINE' },
            { id: 19, type: 'danger', lat: 59.93, lng: 30.30, year: 2027, title: 'INSTITUT VAVILOV', date: '14 AVR 2027', desc: 'St Pétersbourg. Vol de la souche originelle "Peste Rouge". Piège dans la chambre forte à Argon. Fuite par le tunnel de la Tourbe.', artifact: 'Fiole de Spores', code: 'PROPHÉTIE : POUSSIÈRE ROUGE' },
            { id: 20, type: 'safe', lat: 59.94, lng: 30.31, year: 2027, title: 'ERMITAGE (QUAI)', date: '14 AVR 2027', desc: 'Exfiltration de St Pétersbourg par hydroptère vers Helsinki grâce au contact Ivan.', artifact: 'Bateau Hydroptère', code: 'EXTRACTION' },
            { id: 21, type: 'danger', lat: 0.00, lng: -18.00, year: 2027, title: 'FOSSE ROMANCHE', date: '10 JUIL 2027', desc: 'Grande Déconnexion. Drones "Mégalodons" attaquant les câbles sous-marins. Contre-mesure électromagnétique depuis le sous-marin Orphée.', artifact: 'Câble Fibre Optique', code: 'PROPHÉTIE : SILENCE' },

            // 2028-2029
            { id: 22, type: 'danger', lat: 50.85, lng: 4.35, year: 2028, title: 'BRUXELLES (OTAN)', date: '7 SEPT 2028', desc: 'Diffusion d\'un Deepfake parfait pour déclencher une guerre mondiale. Démasqué grâce au tableau de Monet à l\'arrière-plan.', artifact: 'Tableau de Monet', code: 'PROPHÉTIE : TRAHISON' },
            { id: 23, type: 'danger', lat: 36.77, lng: -119.41, year: 2029, title: 'CALIFORNIE', date: '15 MARS 2029', desc: 'Chute des Abeilles. Attaque acoustique dans la Vallée Centrale. Contre-mesure via les éoliennes diffusant un contre-chant.', artifact: 'Abeille Dorée', code: 'PROPHÉTIE : DANSEUSE' },
            { id: 24, type: 'danger', lat: 51.50, lng: -0.08, year: 2029, title: 'LONDRES - SHARD', date: '31 JUIL 2029', desc: 'Crypto-Crash. Attaque quantique sur la Blockchain. QG financier de Burke. Contre-attaque "Protocole Heisenberg".', artifact: 'Serveur Quantique', code: 'PROPHÉTIE : OR DU SERPENT' },

            // 2030
            { id: 25, type: 'danger', lat: 51.95, lng: 4.14, year: 2030, title: 'ROTTERDAM', date: '18 AVR 2030', desc: 'Peste de l\'Acier. Bactérie mangeuse de métal dans la ferraille. Sabotage du déchargement avec un Reach Stacker.', artifact: 'Poutrelle Corrodée', code: 'PROPHÉTIE : ROUILLE' },
            { id: 26, type: 'danger', lat: -75.50, lng: -106.00, year: 2030, title: 'THWAITES', date: '5 NOV 2030', desc: 'Glacier Antarctique. Tentative d\'effondrement du glacier par charges thermiques. Intervention sous-glaciaire avec le ROV Styx.', artifact: 'Carotte de Glace', code: 'PROPHÉTIE : CŒUR DE GLACE' },

            // 2031-2032
            { id: 27, type: 'danger', lat: 30.82, lng: 111.00, year: 2031, title: '3 GORGES', date: '2 SEPT 2031', desc: 'Chine. Piratage de l\'IA du barrage pour provoquer une inondation majeure via glissement de terrain.', artifact: 'Serveur IA', code: 'PROPHÉTIE : GRAND DRAGON' },
            { id: 28, type: 'safe', lat: 39.90, lng: 116.40, year: 2031, title: 'PÉKIN', date: '2 SEPT 2031', desc: 'Café Starbucks. Point d\'accès de Keller pour pirater le barrage. Fuite in extremis face aux services secrets.', artifact: 'Ordinateur Portable', code: 'HACKING' },
            { id: 29, type: 'danger', lat: 67.85, lng: 20.22, year: 2032, title: 'KIRUNA', date: '22 MARS 2032', desc: 'Espace. Syndrome de Kessler. Tentative de destruction de l\'orbite basse. Déplacement du satellite Envisat.', artifact: 'Débris Spatial', code: 'PROPHÉTIE : PLUIE DE FER' },
            { id: 30, type: 'danger', lat: -7.94, lng: -14.37, year: 2032, title: 'ASCENSION', date: '20 AOUT 2032', desc: 'Aveuglement GPS. Sabotage des stations de synchronisation (L\'Enclume du Diable).', artifact: 'Répéteur Pirate', code: 'PROPHÉTIE : ÉTOILES' },
            { id: 31, type: 'danger', lat: 8.71, lng: 167.73, year: 2032, title: 'KWAJALEIN', date: '20 AOUT 2032', desc: 'Pacifique. Second site de sabotage GPS.', artifact: 'Antenne GPS', code: 'CIBLE SECONDAIRE' },
            { id: 32, type: 'danger', lat: 28.39, lng: -80.60, year: 2032, title: 'CAP CANAVERAL', date: '20 AOUT 2032', desc: 'Floride. Troisième site de sabotage GPS.', artifact: 'Antenne GPS', code: 'CIBLE TERTIAIRE' },

            // 2033
            { id: 33, type: 'danger', lat: 36.58, lng: -89.52, year: 2033, title: 'NEW MADRID', date: '21 JAN 2033', desc: 'Arkansas (Monts Ozarks). Amplification sismique par résonateurs cachés dans des grottes. David protège sa région natale.', artifact: 'Résonateur Sonique', code: 'PROPHÉTIE : CHANT DE PIERRE' },
            { id: 34, type: 'danger', lat: 37.05, lng: -3.31, year: 2033, title: 'SIERRA NEVADA', date: '4 AVR 2033', desc: 'Labo Altas Cumbres (Espagne). Virus Éridanus. Rébecca vole l\'antidote et détruit les données par irradiation. Fuite par le conduit de refroidissement.', artifact: 'Fiole Virus Éridanus', code: 'PROPHÉTIE : FIÈVRE DU CIEL' },
            { id: 35, type: 'danger', lat: 78.23, lng: 15.49, year: 2033, title: 'SVALBARD', date: '7 OCT 2033', desc: 'Projet Arca. Assaut du bunker secret de Burke sous la réserve de semences. Récupération des plans de Genesis. Sacrifice de Blackwood.', artifact: 'Disque Dur Genesis', code: 'CIBLE PRIORITAIRE' },
            { id: 36, type: 'danger', lat: 45.07, lng: 7.68, year: 2033, title: 'TURIN', date: 'OCT 2033', desc: 'Tentative de vol du Saint-Suaire et faux attentat. Poursuite dans les souterrains romains. Piège au gaz.', artifact: 'Caisson en Titane', code: 'PROPHÉTIE : IMAGE CONSUMÉE' },
            { id: 37, type: 'safe', lat: 40.81, lng: 14.21, year: 2033, title: 'VILLA LYSIS', date: 'NOV 2033', desc: 'Naples. QG temporaire pour l\'opération Volcan. Coordination des sabotages.', artifact: 'Carte Sismique', code: 'BASE GAMMA' },
            { id: 38, type: 'danger', lat: 40.83, lng: 14.14, year: 2033, title: 'POUZZOLES', date: '12 NOV 2033', desc: 'Temple Sérapis. Sabotage du premier résonateur. Combat avec les Veilleurs.', artifact: 'Obturateur Cryo', code: 'PROPHÉTIE : ABÎME' },
            { id: 39, type: 'danger', lat: 40.84, lng: 14.07, year: 2033, title: 'LAC AVERNE', date: '12 NOV 2033', desc: 'Enfers romains. Sabotage du deuxième résonateur.', artifact: 'Obturateur Cryo', code: 'PROPHÉTIE : ABÎME' },
            { id: 40, type: 'danger', lat: 40.86, lng: 14.25, year: 2033, title: 'CATACOMBES', date: '12 NOV 2033', desc: 'San Gennaro. Sabotage final du dernier résonateur juste avant l\'éruption.', artifact: 'Obturateur Cryo', code: 'PROPHÉTIE : ABÎME' },

            // 2034
            { id: 41, type: 'danger', lat: 45.96, lng: 63.30, year: 2034, title: 'BAÏKONOUR', date: '20 MARS 2034', desc: 'Lancement du missile Satan contenant le satellite Genesis-12 (Antimatière).', artifact: 'Plan de vol ICBM', code: 'MENACE TERMINALE' },
            { id: 42, type: 'safe', lat: 31.774, lng: 35.222, year: 2034, title: 'KING DAVID', date: '21 MARS 2034', desc: 'Jérusalem. Salle de crise finale dans la suite présidentielle. Keller pirate l\'Arche.', artifact: 'Terminal Crypté', code: 'QG FINAL' },
            { id: 43, type: 'intel', lat: 31.77, lng: 35.23, year: 2034, title: 'JÉRUSALEM', date: '21 MARS 2034', desc: 'LE FINAL. Dôme du Rocher. Transmutation de l\'antimatière par résonance harmonique. Chute de Burke.', artifact: 'Pierre Angulaire', code: 'NOUVEAU MILLÉNAIRE' },
            
            // 2074
            { id: 44, type: 'intel', lat: 32.80, lng: 34.99, year: 2034, title: 'HAÏFA (2074)', date: 'FUTUR', desc: 'Épilogue. Retraite de Samuel. Le monde apaisé.', artifact: 'Livre de Samuel', code: 'HÉRITAGE' },
            { id: 45, type: 'intel', lat: 31.74, lng: 35.46, year: 2034, title: 'QUMRÂN (2074)', date: 'FUTUR', desc: 'Découverte de la dernière lettre d\'Elijah Shepherd dans les grottes.', artifact: 'Parchemin Ancien', code: 'MÉMOIRE' }
        ];

        let markers = [];
        let polylineLayer = null;
        let currentFilter = 'all';
        let currentStoryIndex = 0;
        let storyModeActive = false;
        let typingTimeout;

        // --- 3. MOTEUR VISUEL ---
        function initMap() {
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            if(polylineLayer) map.removeLayer(polylineLayer);

            const sortedLocs = [...locations].sort((a, b) => a.order - b.order);
            const latlngs = sortedLocs.map(loc => [loc.lat, loc.lng]);

            polylineLayer = L.polyline(latlngs, {
                color: 'var(--neon-blue)', weight: 1, opacity: 0.3, dashArray: '4, 8', lineCap: 'square'
            }).addTo(map);

            locations.forEach(loc => {
                const shapeClass = loc.type === 'danger' ? 'shape-square' : (loc.type === 'intel' ? 'shape-hex' : 'shape-circle');
                const html = `<div class="marker-icon marker-${loc.type} ${shapeClass}" id="marker-${loc.id}">${loc.id}</div><div class="target-lock" id="lock-${loc.id}"></div>`;
                
                const icon = L.divIcon({
                    className: 'custom-div-icon',
                    html: html,
                    iconSize: [24, 24], iconAnchor: [12, 12]
                });

                const marker = L.marker([loc.lat, loc.lng], {icon: icon})
                    .addTo(map)
                    .on('click', () => selectLocation(loc));
                
                marker.data = loc;
                markers.push(marker);
            });
            updateTimeline(document.getElementById('timeline-slider').value);
        }

        function updateTimeline(year) {
            document.getElementById('timeline-val').innerText = year;
            document.getElementById('date-display').innerText = year;
            
            markers.forEach(marker => {
                const isVisibleTime = marker.data.year <= year;
                const isVisibleType = currentFilter === 'all' || marker.data.type === currentFilter;
                
                if (isVisibleTime && isVisibleType) {
                    if (!map.hasLayer(marker)) map.addLayer(marker);
                    marker.setOpacity(marker.data.year < year ? 0.5 : 1);
                } else {
                    map.removeLayer(marker);
                }
            });
        }

        function setFilter(type) {
            currentFilter = type;
            document.querySelectorAll('.btn-tac').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            updateTimeline(document.getElementById('timeline-slider').value);
        }

        function selectLocation(data) {
            // Target Lock FX
            document.querySelectorAll('.target-lock').forEach(el => el.style.display = 'none');
            document.getElementById(`lock-${data.id}`).style.display = 'block';

            const panel = document.getElementById('info-panel');
            const content = document.getElementById('panel-content');
            
            let badgeClass = 'classified-stamp';
            let color = 'white';
            if (data.type === 'danger') { color = 'var(--neon-red)'; badgeClass += ' danger'; }
            else if (data.type === 'safe') { color = 'var(--neon-blue)'; }
            else { color = 'var(--neon-gold)'; }

            // IMAGE GENERATION (Pollinations.ai)
            const seed = 12345; // Fixed seed for permanence
            const prompt = encodeURIComponent(`cinematic shot of ${data.title} ${data.artifact}, spy thriller style, dark moody lighting, high tech, detailed, 8k, unreal engine 5 render`);
            const imgUrl = `https://image.pollinations.ai/prompt/${prompt}?seed=${seed}&width=600&height=400&nologo=true`;

            // Bouton Next (Mode Story)
            let nextBtn = '';
            if(storyModeActive) {
                nextBtn = `<button class="btn-next-step" onclick="forceNextStep()">ÉTAPE SUIVANTE >></button>`;
            }

            content.innerHTML = `
                <div class="data-header" style="border-color:${color}">
                    <h2 class="data-title" style="color:${color}">${data.title}</h2>
                    <div class="data-meta">
                        <span>COORDINATES: ${data.lat.toFixed(4)} N / ${data.lng.toFixed(4)} E</span>
                        <span>[ ${data.date} ]</span>
                    </div>
                    <div class="${badgeClass}" style="border-color:${color}; color:${color}">${data.code}</div>
                </div>
                
                <div class="data-content">
                    <p class="typewriter-text" id="desc-box"></p>
                    
                    <div class="evidence-box">
                        <div class="evidence-header">VISUAL EVIDENCE REF-${data.id}</div>
                        <div class="evidence-img">
                            <img src="${imgUrl}" onload="this.classList.add('loaded')" alt="Evidence">
                            <div class="evidence-overlay"></div>
                        </div>
                    </div>
                    ${nextBtn}
                </div>
            `;

            panel.classList.add('active');
            map.flyTo([data.lat, data.lng], 6, {duration: 1.5});

            // Typewriter Effect
            const text = data.desc;
            const el = document.getElementById('desc-box');
            el.innerHTML = '';
            el.classList.add('cursor');
            if (typingTimeout) clearInterval(typingTimeout);
            let i = 0;
            typingTimeout = setInterval(() => {
                if (i < text.length) {
                    el.innerHTML += text.charAt(i);
                    i++;
                } else {
                    el.classList.remove('cursor');
                    clearInterval(typingTimeout);
                }
            }, 25);
        }

        function closePanel() {
            document.getElementById('info-panel').classList.remove('active');
            document.querySelectorAll('.target-lock').forEach(el => el.style.display = 'none');
            if (!storyModeActive) map.flyTo([40, 10], 3);
        }

        function startStoryMode() {
            if(currentStoryIndex >= locations.length) currentStoryIndex = 0;
            storyModeActive = true;
            document.getElementById('btn-story').innerText = "TRAQUE EN COURS...";
            nextStep();
        }

        function nextStep() {
            if (!storyModeActive || currentStoryIndex >= locations.length) {
                storyModeActive = false;
                document.getElementById('btn-story').innerText = "LANCER LA TRAQUE";
                return;
            }
            
            const loc = locations.sort((a,b) => a.order - b.order)[currentStoryIndex];
            document.getElementById('timeline-slider').value = loc.year;
            updateTimeline(loc.year);
            selectLocation(loc);
            
            // Gestion Auto-Play
            const isAuto = document.getElementById('autoPlayCheck').checked;
            if(isAuto) {
                currentStoryIndex++;
                setTimeout(nextStep, 8000); 
            }
        }

        function forceNextStep() {
            // Avance manuelle
            // Si on est en manuel, il faut incrémenter l'index ici car nextStep() ne l'a pas fait automatiquement
            const isAuto = document.getElementById('autoPlayCheck').checked;
            if(!isAuto) {
                currentStoryIndex++;
            }
            // Si on est en auto, l'index est déjà géré, mais on veut "sauter" le timer
            // Pour simplifier : on rappelle simplement nextStep, qui gère la suite
            // Note: en mode auto, cela peut créer un double appel si on clique vite, mais pour ce prototype c'est acceptable.
            // Idéalement on clear le timeout précédent.
            // Simple fix pour le mode manuel :
            nextStep();
        }

        initMap();

    </script>
</body>
</html>