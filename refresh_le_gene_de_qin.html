<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Générateur de Cache Séquentiel - Le Gène De Qin</title>
    <!-- Chargez votre fichier de données ici -->
    <script src="le_gene_de_qin.js"></script>
    <style>
        body { font-family: 'Courier New', monospace; background: #0a0b10; color: #c9a063; padding: 20px; }
        
        /* Barre de statut fixe */
        #status-bar { 
            position: sticky; top: 0; 
            background: #1f2430; 
            padding: 15px; 
            border-bottom: 2px solid #c9a063; 
            z-index: 100; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .stats { font-size: 14px; }
        .current-action { color: #fff; font-weight: bold; margin-top: 5px; }
        
        /* Galerie */
        .gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; margin-top: 20px; }
        
        .img-card { 
            background: #000; 
            border: 1px solid #333; 
            aspect-ratio: 16/9; 
            position: relative; 
            overflow: hidden; 
            transition: all 0.3s;
        }
        
        .img-card.success { border-color: #2e7d32; }
        .img-card.error { border-color: #b71c1c; }
        .img-card.active { border-color: #c9a063; box-shadow: 0 0 10px #c9a063; }

        .img-card img { width: 100%; height: 100%; object-fit: cover; opacity: 0.6; }
        .img-card.success img { opacity: 1; }

        .info-overlay { 
            position: absolute; bottom: 0; left: 0; right: 0; 
            background: rgba(0,0,0,0.8); 
            padding: 5px; 
            font-size: 10px; 
            display: flex; 
            justify-content: space-between;
        }
        
        .status-text { font-weight: bold; }
        .status-text.pending { color: #888; }
        .status-text.loading { color: #ffb74d; }
        .status-text.ok { color: #66bb6a; }
        .status-text.fail { color: #ef5350; }

        /* Boutons */
        button { 
            padding: 10px 20px; 
            cursor: pointer; 
            background: #c9a063; 
            color: #000; 
            border: none; 
            font-weight: bold; 
            border-radius: 4px; 
        }
        button:disabled { background: #555; color: #888; cursor: not-allowed; }
        button.retry { background: #b71c1c; color: #fff; display: none; }
    </style>
</head>
<body>

<div id="status-bar">
    <div class="stats">
        <div>Total images : <span id="total-count">0</span></div>
        <div>Succès : <span id="success-count" style="color:#66bb6a">0</span> | Échecs : <span id="fail-count" style="color:#ef5350">0</span></div>
        <div class="current-action" id="action-msg">Prêt à démarrer...</div>
    </div>
    <div class="controls">
        <button id="btn-start" onclick="startGeneration()">Démarrer Génération Séquentielle</button>
        <button id="btn-retry" class="retry" onclick="retryFailed()">Réessayer les Erreurs</button>
    </div>
</div>

<div id="gallery" class="gallery"></div>

<script>
    // --- CONFIGURATION ---
    const DELAY_SUCCESS = 2000; // Pause de 2s après une réussite (pour ne pas spammer)
    const DELAY_RETRY = 5000;   // Pause de 5s avant de réessayer une erreur
    const MAX_RETRIES = 3;      // Nombre de tentatives par image
    
    const POLLINATIONS_URL = "https://image.pollinations.ai/prompt/";
//    const STYLE_PROMPT = "Cinematic movie shot, thriller atmosphere, highly detailed, 8k, dramatic lighting, ";
	const STYLE_PROMPT = "Cinematic movie shot, cold blue atmosphere, snowy mountains, ancient chinese terracotta mystery, dna helix, scientific lab, dramatic lighting, 8k, ";
    const SEED = 9998; 

    // --- VARIABLES ---
    let allPrompts = [];
    let processingQueue = [];
    let isRunning = false;

    // --- INITIALISATION ---
    function init() {
        if (!window.GAME_DATA) {
            alert("Erreur critique : le fichier de données JS est introuvable ou invalide.");
            return;
        }

        const nodes = window.GAME_DATA.nodes;
        let index = 0;

        // 1. Extraction de tous les prompts
        for (const key in nodes) {
            // On prend le prompt ou un fallback par défaut
            let rawPrompt = nodes[key].img_prompt || "Mystery book cover";
            
            // Construction de l'URL exacte (identique à celle du jeu)
            const safePrompt = encodeURIComponent(STYLE_PROMPT + rawPrompt);
            const url = `${POLLINATIONS_URL}${safePrompt}?width=800&height=400&nologo=true&seed=${SEED}`;

            allPrompts.push({
                id: key,
                index: index,
                url: url,
                status: 'pending', // pending, loading, success, error
                retries: 0
            });
            index++;
        }

        // 2. Mise à jour UI initiale
        document.getElementById('total-count').innerText = allPrompts.length;
        createGrid();
    }

    function createGrid() {
        const gallery = document.getElementById('gallery');
        gallery.innerHTML = '';

        allPrompts.forEach(item => {
            const div = document.createElement('div');
            div.className = 'img-card';
            div.id = `card-${item.index}`;
            
            // On met une image vide ou un placeholder au début
            div.innerHTML = `
                <img id="img-${item.index}" src="" alt="En attente" style="display:none">
                <div class="info-overlay">
                    <span>${item.id}</span>
                    <span id="status-${item.index}" class="status-text pending">EN ATTENTE</span>
                </div>
            `;
            gallery.appendChild(div);
        });
    }

    // --- MOTEUR DE GÉNÉRATION ---

    function startGeneration() {
        if (isRunning) return;
        
        // On ne traite que ceux qui ne sont pas déjà 'success'
        processingQueue = allPrompts.filter(p => p.status !== 'success');
        
        if (processingQueue.length === 0) {
            document.getElementById('action-msg').innerText = "Toutes les images sont déjà générées !";
            return;
        }

        isRunning = true;
        document.getElementById('btn-start').disabled = true;
        document.getElementById('btn-retry').style.display = 'none';
        
        processNext();
    }

    function retryFailed() {
        // Réinitialiser le statut des erreurs pour les retenter
        allPrompts.forEach(p => {
            if (p.status === 'error') {
                p.status = 'pending';
                p.retries = 0;
                // Reset visuel
                document.getElementById(`card-${p.index}`).className = 'img-card';
                document.getElementById(`status-${p.index}`).className = 'status-text pending';
                document.getElementById(`status-${p.index}`).innerText = 'EN ATTENTE';
            }
        });
        startGeneration();
    }

    function processNext() {
        if (processingQueue.length === 0) {
            finishBatch();
            return;
        }

        const item = processingQueue[0]; // On prend le premier
        updateCardStatus(item, 'loading');
        
        document.getElementById('action-msg').innerText = `Génération en cours : ${item.id} (Tentative ${item.retries + 1}/${MAX_RETRIES})...`;

        // Préchargement de l'image
        const imgLoader = new Image();
        
        imgLoader.onload = function() {
            // SUCCÈS
            item.status = 'success';
            updateCardStatus(item, 'success', this.src);
            
            // On l'enlève de la file
            processingQueue.shift();
            updateCounters();
            
            // Petite pause avant la suivante pour laisser respirer le serveur
            setTimeout(processNext, DELAY_SUCCESS);
        };

        imgLoader.onerror = function() {
            // ÉCHEC
            item.retries++;
            
            if (item.retries < MAX_RETRIES) {
                // On réessaie la même image après un délai plus long
                document.getElementById('action-msg').innerText = `Erreur sur ${item.id}. Nouvelle tentative dans 5s...`;
                setTimeout(processNext, DELAY_RETRY);
            } else {
                // Abandon après X tentatives
                item.status = 'error';
                updateCardStatus(item, 'error');
                
                // On passe à la suivante
                processingQueue.shift();
                updateCounters();
                setTimeout(processNext, DELAY_SUCCESS);
            }
        };

        // Déclenchement
        imgLoader.src = item.url;
    }

    // --- UTILITAIRES UI ---

    function updateCardStatus(item, status, imgSrc = null) {
        const card = document.getElementById(`card-${item.index}`);
        const statusSpan = document.getElementById(`status-${item.index}`);
        const imgTag = document.getElementById(`img-${item.index}`);

        // Retirer les anciennes classes
        card.classList.remove('active', 'success', 'error');

        if (status === 'loading') {
            card.classList.add('active');
            statusSpan.className = 'status-text loading';
            statusSpan.innerText = `GÉNÉRATION (${item.retries + 1})...`;
            // Scroll automatique vers l'élément en cours si nécessaire
            card.scrollIntoView({ behavior: "smooth", block: "center" });
        } 
        else if (status === 'success') {
            card.classList.add('success');
            statusSpan.className = 'status-text ok';
            statusSpan.innerText = 'OK';
            if (imgSrc) {
                imgTag.src = imgSrc;
                imgTag.style.display = 'block';
            }
        } 
        else if (status === 'error') {
            card.classList.add('error');
            statusSpan.className = 'status-text fail';
            statusSpan.innerText = 'ÉCHEC';
        }
    }

    function updateCounters() {
        const success = allPrompts.filter(p => p.status === 'success').length;
        const fail = allPrompts.filter(p => p.status === 'error').length;
        
        document.getElementById('success-count').innerText = success;
        document.getElementById('fail-count').innerText = fail;
    }

    function finishBatch() {
        isRunning = false;
        const failCount = allPrompts.filter(p => p.status === 'error').length;
        
        document.getElementById('btn-start').disabled = false;
        document.getElementById('action-msg').innerText = failCount > 0 
            ? "Terminé avec des erreurs. Cliquez sur 'Réessayer' pour les échoués." 
            : "Terminé ! Toutes les images sont prêtes.";

        if (failCount > 0) {
            document.getElementById('btn-retry').style.display = 'inline-block';
        }
    }

    // Démarrage au chargement
    window.onload = init;

</script>
</body>
</html>